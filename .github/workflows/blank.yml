## ejercicio 9
## Ejercicio 9 - Simulaci√≥n de despliegue con Docker Compose + cleanup

name: CI (dummy)
env:
    IMAGE_NAME: a
    APP_URL: b

on: ## Event triggers (on:): cu√°ndo se ejecuta (push, PR, manual, schedule, etc.).
  push: ## El workflow se ejecutar√° cada vez que alguien suba c√≥digo (haga un git push) a cualquier rama del repositorio
  pull_request:
    branches: [develop, master] ##El workflow solo se activar√° si se abre (o se actualiza) un Pull Request que tenga como objetivo las ramas develop o master.
  workflow_dispatch: ##Clic manual en la web
    inputs:
      RUN_CD:
        description: "Run CD stage"
        required: false
        type: boolean
        default: false
      DEPLOY_ENV:
        description: "Entorno de despliegue"
        required: false
        type: choice
        options:
          - DEV
          - PRO
        default: DEV

jobs: ## contenedor de todas las tareas. Aqu√≠ puedes tener varios (ej: ci, test, deploy).
  ci: ## Es el identificador de este job.
    name: Integraci√≥n Continua
    runs-on: ubuntu-latest # Define el sistema operativo (Linux) 
    env:
      IMAGE_NAME: c
      APP_URL: d
    environment: DEV ## o seleccionar de manera dinamica DEV vs PRO:  ${{ github.ref_name == 'master' && 'PRO' || 'DEV' }}
    steps: ## Es la lista secuencial de tareas.
      - name: Checkout del repositorio
        uses: actions/checkout@v4 # Copia tu c√≥digo en el runner. esta l√≠nea "descarga" tu c√≥digo dentro de la m√°quina para que puedas trabajar con √©l (leer archivos, compilar, etc.).
      - name: Info
        run: |
          echo "refname: ${{ github.ref_name }}"
          echo "sha: ${{ github.sha }}"
          echo "os: ${{ runner.os }}"
          echo "name: ${{ runner.name }}"      
      - name: "Mostrar valores"
        run: |
          echo "IMAGE_NAME: ${{ env.IMAGE_NAME }}"
          echo "APP_URL: ${{ env.APP_URL }}"
      - name: "Mostrar Par√°metros inputs"
        run: |
          echo "RUN_CD: ${{ inputs.RUN_CD }}"
      - name: "Mostrar environment DEV"
        run: |
          echo "REGISTRY_HOST: ${{ vars.REGISTRY_HOST }}"
          echo "ARTIFACTORY_URL: ${{ vars.ARTIFACTORY_URL  }}"
          echo "REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}"
      - name: "Construir imagen y ejecutar Tests/Lint" ## Al usar el flag -f, le indicas a Docker la ruta exacta y el nombre de tu archivo. Si no lo pones, Docker buscar√° por defecto un archivo llamado simplemente Dockerfile en la ra√≠z, y fallar√°.
        run: |
          docker build -t mi-aplicacion-ci:0.0.1 \
            -f devops/ci.Dockerfile .
  cd:
    name: Despliegue Continuo
    needs: ci # Asegura que el CI pase primero
    if: github.ref_name == 'develop' || github.ref_name == 'master' || github.ref_name == 'main' || inputs.RUN_CD == true
    runs-on: ubuntu-latest    
    steps: 
      - name: "Validaci√≥n de Condici√≥n de Despliegue"
        run: |
          echo "rama: ${{ github.ref_name }}"
          echo "inputs.RUN_CD: ${{ inputs.RUN_CD }}"    
      - name: "Checkout del repositorio"
        uses: actions/checkout@v4    
      - name: "Volver a construir la imagen en este job." ## Otra opcion es subirla al Registry
        run:  docker build -t mi-aplicacion-ci:0.0.1 -f devops/ci.Dockerfile . ## # Necesitamos construirla AQU√ç para que el Compose la encuentre
      - name: "Verificar Directorio y Archivos"
        run: |
          echo "üìç Directorio actual: $(pwd)"
          echo "üìÇ Contenido del directorio:"
          ls -R
          
          if [ -f "docker-compose.yml" ]; then
            echo "‚úÖ docker-compose.yml encontrado en la ra√≠z."
          else
            echo "‚ùå ERROR: No veo el archivo docker-compose.yml"
            exit 1
          fi        
      - name: "Levantar contenedor"
        run: docker compose up -d  
      - name: "Esperar 10 segundos a que se carguen los servicios"
        run: sleep 10
      - name: "Inspeccionar recursos creados"
        run: |
          echo "--- CONTENEDORES ACTIVOS ---"
          docker ps -a 

          echo -e "\n--- REDES DE DOCKER ---"
          docker network ls

          echo -e "\n--- VOL√öMENES ---"
          docker volume ls      
      - name: "Cleanup"
        if: always() ## siempre se ejecuta
        run: |
          echo "Limpiando contenedores y vol√∫menes..."
          docker compose down -v

        
